<!-- 
  This script tests the keystore reload and recover capabilities.
  Please run this script as the last test to avoid (unlikely)
  problems with the other tests
-->

<action>
	<actionname>1.0.0.0,Opening key store in manager mode</actionname>
	<actiontype>init</actiontype>
	<actionbody>
		<mode>manager</mode>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.0 Delete everything * Test keystore close & reload consistency *</actionname>
	<actiontype>deletekeys</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
<actionname>1.1.2 Import a RSA key</actionname>
	<actiontype>importkey</actiontype>
	<actionbody>
		<ImportData>pkcs8rsa.001</ImportData>
		<keyusage>allusagesbutNR</keyusage>
		<keylabel>gm0_rsa</keylabel>
		<keyaccesstype>Extractable</keyaccesstype>
		<passphrase>create pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.1.3 Set passphrase timeout to "don't cache"</actionname>
	<actiontype>settimeout</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<timeout>0</timeout>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
<actionname>1.1.4 Import a DSA key</actionname>
	<actiontype>importkey</actiontype>
	<actionbody>
		<ImportData>pkcs8dsa1.001</ImportData>
		<keyusage>DSAUsage</keyusage>
		<keylabel>gm1_dsa</keylabel>
		<keyaccesstype>Extractable</keyaccesstype>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>



<action>
	<actionname>1.1.5 List everything (TEST ID: GT0140-KEY001)</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>2</listcount>
		<foundkey>gm0_rsa</foundkey>
		<foundkey>gm1_dsa</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>



<action>
	<actionname>1.1.6 Closing key store</actionname>
	<actiontype>delete</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.7 Sleep 5 seconds</actionname>
	<actiontype>sleep</actiontype>
	<actionbody>
          <seconds>5</seconds>
        </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.8 Opening key store in manager mode</actionname>
	<actiontype>init</actiontype>
	<actionbody>
		<mode>manager</mode>
		<serveroom>0</serveroom>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.9 List everything (TEST ID: GT0140-KEY001)</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>2</listcount>
		<foundkey>gm0_rsa</foundkey>
		<foundkey>gm1_dsa</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

// Test keys still work ok

<action>
	<actionname>1.1.10.0,Get it again</actionname>
	<actiontype>getkeyinfo</actiontype>
	<actionbody>
		<keyusage>allusagesbutNR</keyusage>
		<keysize>512</keysize>
		<keylabel>gm0_rsa</keylabel>
		<keyalgorithm>RSA</keyalgorithm>
		<keyaccesstype>Extractable</keyaccesstype>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.1,Open it</actionname>
	<actiontype>open</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>RSA</open>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.2,Open a gm0_rsa for decrypt</actionname>
	<actiontype>open</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>Decrypt</open>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>Decrypt</actionname>
	<actiontype>decrypt</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<text>Ook!</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.2.1, Sign with a gm0_rsa, 20 char text</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>RSA</open>
		<text>This is text of 20 .</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.2.2, Sign with a gm0_rsa, 32 char text</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>RSA</open>
		<text>This is text of thirty-two chars</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.2.2.1, Sign digest with a gm0_rsa</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>RSA</open>
		<signdigest>1</signdigest>
		<text>digested!</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>

</action>
<action>
	<actionname>1.1.10.2.3, Sign digest with a gm0_rsa, text too large</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>RSA</open>
		<signdigest>2</signdigest>
		<text>Had we but world enough, and time,
This coyness, lady, were no crime.
We would sit down and think which way
To walk, and pass our long love's day;
Thou by the Indian Ganges' side
Shouldst rubies find; I by the tide
Of Humber would complain. I would
Love you ten years before the Flood;
And you should, if you please, refuse
Till the conversion of the Jews.
My vegetable love should grow
Vaster than empires, and more slow.
An hundred years should go to praise
Thine eyes, and on thy forehead gaze;
Two hundred to adore each breast,
But thirty thousand to the rest;
An age at least to every part,
And the last age should show your heart.
For, lady, you deserve this state,
Nor would I love at lower rate.

        But at my back I always hear
Time's winged chariot hurrying near;
And yonder all before us lie
Deserts of vast eternity.
Thy beauty shall no more be found,
Nor, in thy marble vault, shall sound
My echoing song; then worms shall try
That long preserv'd virginity,
And your quaint honour turn to dust,
And into ashes all my lust.
The grave's a fine and private place,
But none I think do there embrace.

        Now therefore, while the youthful hue
Sits on thy skin like morning dew,
And while thy willing soul transpires
At every pore with instant fires,
Now let us sport us while we may;
And now, like am'rous birds of prey,
Rather at once our time devour,
Than languish in his slow-chapp'd power.
Let us roll all our strength, and all
Our sweetness, up into one ball;
And tear our pleasures with rough strife
Thorough the iron gates of life.
Thus, though we cannot make our sun
Stand still, yet we will make him run</text>
	</actionbody>
	<actionresult>
		<return>KErrOverflow</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.3,Open a gm0_rsa as a DSA key</actionname>
	<actiontype>open</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>DSA</open>
	</actionbody>
	<actionresult>
		<return>KErrKeyAlgorithm</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.10.4,Open a gm0_rsa as a DH key</actionname>
	<actiontype>open</actiontype>
	<actionbody>
		<keylabel>gm0_rsa</keylabel>
		<open>DH</open>
	</actionbody>
	<actionresult>
		<return>KErrKeyAlgorithm</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.11,Get it again</actionname>
	<actiontype>getkeyinfo</actiontype>
	<actionbody>
		<keyusage>DSAUsage</keyusage>
		<keysize>512</keysize>
		<keylabel>gm1_dsa</keylabel>
		<keyalgorithm>DSA</keyalgorithm>
		<keyaccesstype>Extractable</keyaccesstype>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.11.1, Sign with a gm1_dsa, 20 char text</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm1_dsa</keylabel>
		<open>DSA</open>
		<text>This is text of 20 .</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.11.2, Sign with gm1_dsa, text too long (21 chars)</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm1_dsa</keylabel>
		<open>DSA</open>
		<text>This is a text of 21.</text>
	</actionbody>
	<actionresult>
		<return>KErrOverflow</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.11.2, Sign digest with gm1_dsa</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm1_dsa</keylabel>
		<open>DSA</open>
		<signdigest>1</signdigest>
		<passphrase>pinkcloud</passphrase>
		<text>Had we but world enough, and time,
This coyness, lady, were no crime.
We would sit down and think which way
To walk, and pass our long love's day;
Thou by the Indian Ganges' side
Shouldst rubies find; I by the tide
Of Humber would complain. I would
Love you ten years before the Flood;
And you should, if you please, refuse
Till the conversion of the Jews.
My vegetable love should grow
Vaster than empires, and more slow.
An hundred years should go to praise
Thine eyes, and on thy forehead gaze;
Two hundred to adore each breast,
But thirty thousand to the rest;
An age at least to every part,
And the last age should show your heart.
For, lady, you deserve this state,
Nor would I love at lower rate.

        But at my back I always hear
Time's winged chariot hurrying near;
And yonder all before us lie
Deserts of vast eternity.
Thy beauty shall no more be found,
Nor, in thy marble vault, shall sound
My echoing song; then worms shall try
That long preserv'd virginity,
And your quaint honour turn to dust,
And into ashes all my lust.
The grave's a fine and private place,
But none I think do there embrace.

        Now therefore, while the youthful hue
Sits on thy skin like morning dew,
And while thy willing soul transpires
At every pore with instant fires,
Now let us sport us while we may;
And now, like am'rous birds of prey,
Rather at once our time devour,
Than languish in his slow-chapp'd power.
Let us roll all our strength, and all
Our sweetness, up into one ball;
And tear our pleasures with rough strife
Thorough the iron gates of life.
Thus, though we cannot make our sun
Stand still, yet we will make him run</text>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.1.11.3, Sign digest with a gm1_dsa, fail hash</actionname>
	<actiontype>sign</actiontype>
	<actionbody>
		<keylabel>gm1_dsa</keylabel>
		<open>DSA</open>
		<signdigest>2</signdigest>
		<text>digest!</text>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrGeneral</return>
	</actionresult>
</action>

//

<action>
	<actionname>1.2.0.0 Test keystore copy-from-rom-if-not-found behaviour</actionname>
	<actiontype>deletekeys</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.0.1 Closing key store</actionname>
	<actiontype>delete</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.0.2 Sleep 5 seconds, when we wake up keys.dat is not in use anymore </actionname>
	<actiontype>sleep</actiontype>
	<actionbody>
          <seconds>5</seconds>
        </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.1 Delete keystore data file</actionname>
	<actiontype>deletekeystoredata</actiontype>
	<actionbody>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.2 Opening key store in manager mode</actionname>
	<actiontype>init</actiontype>
	<actionbody>
		<mode>manager</mode>
		<serveroom>0</serveroom>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.3 List everything (rom keystore contains 2 keys)</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>2</listcount>
		<foundkey>gm0</foundkey>
		<foundkey>gm1</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
<actionname>1.2.4 Import a DSA key</actionname>
	<actiontype>importkey</actiontype>
	<actionbody>
		<ImportData>pkcs8dsa1.001</ImportData>
		<keyusage>DSAUsage</keyusage>
		<keylabel>gm1_dsa</keylabel>
		<keyaccesstype>Extractable</keyaccesstype>
		<passphrase>pinkcloud</passphrase>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.5 List everything</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>3</listcount>
		<foundkey>gm0</foundkey>
		<foundkey>gm1</foundkey>
		<foundkey>gm1_dsa</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.3.0 Test keystore copy-from-rom-if-corrupt behaviour (store open, canot corrupt)</actionname>
	<actiontype>corrupt</actiontype>
	<actionbody>
           <corruption>Once upon a time...</corruption>  
        </actionbody>
	<actionresult>
		<return>KErrInUse</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.5 List everything</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>3</listcount>
		<foundkey>gm0</foundkey>
		<foundkey>gm1</foundkey>
		<foundkey>gm1_dsa</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.6 Closing key store</actionname>
	<actiontype>delete</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.7 Sleep 5 seconds, when we wake up keys.dat is not in use anymore </actionname>
	<actiontype>sleep</actiontype>
	<actionbody>
          <seconds>5</seconds>
        </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.8 Test keystore copy-from-rom-if-corrupt behaviour</actionname>
	<actiontype>corrupt</actiontype>
	<actionbody>
           <corruption> CERT has been criticized in the past for being frugal with vulnerability information.  They don't publish exploits, for one, which means k1ddi3z prefer FD. </corruption>  
        </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.2 Opening key store in manager mode</actionname>
	<actiontype>init</actiontype>
	<actionbody>
		<mode>manager</mode>
		<serveroom>0</serveroom>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>



<action>
	<actionname>1.2.9 List everything (rom keystore contains 2 keys)</actionname>
	<actiontype>listkeys</actiontype>
	<actionbody>
		<listcount>2</listcount>
		<foundkey>gm0</foundkey>
		<foundkey>gm1</foundkey>
	</actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>


<action>
	<actionname>1.2.10 Delete everything</actionname>
	<actiontype>deletekeys</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.11 Closing key store</actionname>
	<actiontype>delete</actiontype>
	<actionbody></actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.12, Sleep 5 seconds</actionname>
	<actiontype>sleep</actiontype>
	<actionbody>
          <seconds>5</seconds>
        </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>

<action>
	<actionname>1.2.13, Check for server heap error</actionname>
	<actiontype>checkserverheaperror</actiontype>
	<actionbody>
    </actionbody>
	<actionresult>
		<return>KErrNone</return>
	</actionresult>
</action>
